---
execute:
  echo: true
  eval: false
  error: false
---


## Rstudio project to Zenodo exercise {#sec-Rproj_zenodo_exercise}
The following exercise is heavily based on [@blondel2024]. We have extracted the most relevant parts to explain the workflow. If you are interested in more details, check out their user manual at: https://cran.r-project.org/web/packages/zen4R/vignettes/zen4R.html.

### Step 1: Install zen4R to access Zenodo through r
For this exercise we will not be using Zenodo directly but Zenodo Sandbox. The Zenodo Sandbox is a separate, secure testing environment where users can explore Zenodo’s features without impacting the main platform's publicly accessible data. It allows you to test file uploads, generate test DOIs, and experiment with API integrations. DOIs created in the sandbox are only for testing and use a different prefix. You will need a separate account and access token for the sandbox, distinct from those used on Zenodo’s main site.

-   Create an account on https://sandbox.zenodo.org.

Zenodo can be accessed with r library zen4R to upload, edit, publish and download data.

-   Install zen4R library with the following code:
```{r}
#install dependency "remotes"
install.packages("remotes")
    
#install zen4R
require("remotes")
install_github("eblondel/zen4R")
```

### Step 2: Create a new Zenodo record
A zenodo record includes metadata, data and a  Digital Object Identifier (DOI) which is automatically generated by Zenodo for all uploads. But before you can add records to Zenodo, you need to access your own account through RStudio. 

-   Go to https://sandbox.zenodo.org/account/settings/applications/.
-   Log into your account and then create a new "Personal access token" in the "Applications" section of your account.
-   Then run the following code in RStudio to establish the access and create a new record.
```{r}
library(zen4R)
    
#Create manager to access your Zenodo repository
zenodo <- ZenodoManager$new(
token = "your_token",
sandbox = TRUE,
logger = "INFO" 
)
    
#Create a new empty record
myrec <- ZenodoRecord$new()
```
If you want to connect to Zenodo and not the Zenodo sandbox, create the token in your Zenodo account and remove the sandbox = True line in the code above.


The types of metadata that can be included in a Zenodo record are vast. A full list can be found in the documentation at https://developers.zenodo.org/#representation. The code below gives some examples.
```{r}
myrec$setTitle("zen4R") #title of the record
myrec$addAdditionalTitle("This is an alternative title", type = "alternative-title")
myrec$setDescription("Interface to 'Zenodo' REST API") #description
myrec$addAdditionalDescription("This is an abstract", type = "abstract")
myrec$setPublicationDate("2024-09-16") #Format YYYY-MM-DD
myrec$setResourceType("dataset")
myrec$addCreator(firstname = "Yourfirstname", lastname = "Yourlastname", role = "datamanager", orcid = "0000-0001-0002-0003")
myrec$setKeywords(c("R","dataset")) #For filtering
myrec$addReference("Blondel E. et al., 2024 zen4R: R Interface to Zenodo REST API")
myrec$setPublisher("CRAN") #Publisher
```
    
A record can be deposited on Zenodo before it is published. This will add the record to your account without making it public yet. A deposited record can still be edited or deleted. You can also upload data to a deposited record. If you prefer a graphical interface, you can also edit the record on the Zenodo website.
```{r}
#deposit record
myrec <- zenodo$depositRecord(myrec, publish = TRUE)

#add data to the record, adjust the path below
zenodo$uploadFile("path/to/your/file", record = myrec)

#delete record if you want to start over
zenodo$deleteRecord(myrec$id)
```


Once you are satisfied with the record, you can proceed with its publication.
```{r}
#publish record
myrec <- zenodo$publishRecord(myrec$id)
```
    
### Step 3: Edit a published Zenodo record
It is also possible to edit or update the metadata of published records.
```{r}
#get your record by metadata query, e.g. by title
myrec <- zenodo$getDepositions(q='title:zen4R')

#get depositions creates a list, access first element
myrec <- myrec[[1]]

#edit metadata
myrec <- zenodo$editRecord(myrec$id)
myrec$setTitle("zen4R 2.0")

#redeposit and publish the edited record
myrec <- zenodo$depositRecord(myrec, publish = TRUE)
```

Once a record has been published, it is not possible to edit the data that has been attached to it. However, it is possible to upload an updated version of the data. The previous version of the data will remain accessible via Zenodo. The record will have one overall DOI, while each version will have its own DOI.
```{r}
# reconnect to your account if necessary
zenodo <- ZenodoManager$new(
  token = "your_token",
  sandbox = TRUE,
  logger = "INFO" 
)

#get your record by querying the metadata, e.g. by title, this will give you a list of all records with that title.
myrec <- zenodo$getDepositions(q='title:zen4R 2.0')

#access the first item in the list, as there should only be one record with that particular title
myrec <- myrec[[1]]

#edit data, delete_latest_files = TRUE deletes data of previous version,
myrec <- zenodo$depositRecordVersion(myrec, delete_latest_files = TRUE, files = "path/to/your/new/file", publish = TRUE)
```
